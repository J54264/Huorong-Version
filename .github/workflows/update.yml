name: Update Version Info

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 00:00 执行（北京时间 08:00）
  workflow_dispatch:     # 允许手动触发

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Fetch and Update README
        run: |
          # 下载 JSON 数据
          curl -o version.json "https://www.huorong.cn/versionShow.php?request_type=1"
          
          # 创建 Python 脚本生成表格
          cat > generate_table.py << 'EOF'
          import json
          from datetime import datetime

          with open('version.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          # 生成 Markdown 表格
          table = "| 架构 | 病毒库版本 | 程序版本 | 生成时间 | 类型 | 文件名 | 大小 | 下载链接 |\n"
          table += "|------|------------|----------|----------|------|--------|------|----------|\n"
          
          # x86/x64 full
          table += f"| x86/x64 | {data['virusVersion']} | {data['version']} | {data['createtime']} | Full | {data['fullName']} | {data['filesize']} | [下载]({data['urlFull']}) |\n"
          # x86/x64 all
          table += f"| x86/x64 | {data['virusVersion']} | {data['version']} | {data['createtime']} | All | {data['allName']} | {data['filesize']} | [下载]({data['urlAll']}) |\n"
          # ARM64 full
          table += f"| ARM64 | {data['virusVersion']} | {data['version']} | {data['createtime']} | Full | {data['armFullName']} | {data['armFilesize']} | [下载]({data['armUrlFull']}) |\n"
          # ARM64 all
          table += f"| ARM64 | {data['virusVersion']} | {data['version']} | {data['createtime']} | All | {data['armAllName']} | {data['armFilesize']} | [下载]({data['armUrlAll']}) |\n"

          # 更新 README.md
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(f"# 版本信息\n\n更新时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (UTC+8)\n\n{table}")
          EOF
          
          # 运行 Python 脚本
          python generate_table.py
          
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "Update version info" || echo "No changes to commit"
          git push
