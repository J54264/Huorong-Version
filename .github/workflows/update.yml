name: Update Virus Definition README

on:
  schedule:
    - cron: '0 0 * * *' # 每天UTC时间0点执行
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch version data
        id: fetch_data
        env:
          VERSION_URL: https://www.huorong.cn/versionShow.php
        run: |
          VERSION_JSON=$(curl -s $VERSION_URL)
          echo "version_data<<EOF" >> $GITHUB_ENV
          echo "$VERSION_JSON" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate markdown table
        id: generate_table
        run: |
          # 解析JSON数据
          VERSION=$(echo "$VERSION_JSON" | jq -r '.version')
          VIRUS_VERSION=$(echo "$VERSION_JSON" | jq -r '.virusVersion')
          CREATION_TIME=$(echo "$VERSION_JSON" | jq -r '.createtime')
          
          # 生成表格内容
          TABLE="
          | 架构类型 | 病毒库版本 | 程序版本 | 生成时间 | 类型 | 文件名 | 大小 | 下载链接 |
          |----------|------------|----------|----------|------|--------|------|----------|
          | x86/x64 | $VIRUS_VERSION | $VERSION | $CREATION_TIME | full | $(echo "$VERSION_JSON" | jq -r '.fullName') | $(echo "$VERSION_JSON" | jq -r '.filesize') | [下载]($(echo "$VERSION_JSON" | jq -r '.urlFull')) |
          | x86/x64 | $VIRUS_VERSION | $VERSION | $CREATION_TIME | All | $(echo "$VERSION_JSON" | jq -r '.allName') | $(echo "$VERSION_JSON" | jq -r '.filesize') | [下载]($(echo "$VERSION_JSON" | jq -r '.urlAll')) |
          | ARM64 | $VIRUS_VERSION | $VERSION | $CREATION_TIME | full | $(echo "$VERSION_JSON" | jq -r '.armFullName') | $(echo "$VERSION_JSON" | jq -r '.armFilesize') | [下载]($(echo "$VERSION_JSON" | jq -r '.armUrlFull')) |
          | ARM64 | $VIRUS_VERSION | $VERSION | $CREATION_TIME | All | $(echo "$VERSION_JSON" | jq -r '.armAllName') | $(echo "$VERSION_JSON" | jq -r '.armFilesize') | [下载]($(echo "$VERSION_JSON" | jq -r '.armUrlAll')) |
          "
          
          # 保存到环境变量
          echo "markdown_table<<EOF" >> $GITHUB_ENV
          echo "$TABLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update README.md
        run: |
          # 替换README中的版本表格
          sed -i '/<!-- VERSION_TABLE_START -->/,/<!-- VERSION_TABLE_END -->/{
            /<!-- VERSION_TABLE_START -->/!{
              /<!-- VERSION_TABLE_END -->/!d
            }
          }' README.md
          
          # 插入新表格
          echo "\n<!-- VERSION_TABLE_START -->\n${markdown_table}\n<!-- VERSION_TABLE_END -->" >> README.md

      - name: Commit changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "Update virus definition versions ($(date +'%Y-%m-%d %H:%M:%S'))" || exit 0
          git push
